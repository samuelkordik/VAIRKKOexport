---
title: "R Notebook"
output: html_notebook
---
```{r}
library(tidyverse)
library(rvest)

  s <- session("https://suite.vairkko.com/APP/index.cfm/BehaviorTracking/Dashboard")


  f <- html_form(s)[[1]]

  f <- html_form_set(f,
                     companyid = get_credential("cid"),
                     username = get_credential("username"),
                     password = get_credential("password"))

  s <- session_submit(s, f) %>%
    session_jump_to("https://suite.vairkko.com/APP/index.cfm/BehaviorTracking/Dashboard")

  incidents <- s %>% html_element("#tableincidents") %>% html_table()
#incidents <- get_behavioral_incidents()


url <- paste0("https://suite.vairkko.com/APP/index.cfm/BehaviorTracking/IncidentDetail?IncidentID=", 033222)

incident_detail <- s %>% session_jump_to(url)


```

```{r}
details <- lst(incident_date = incident_detail %>% html_element("#IncidentDate") %>% html_attr("value"),
               followers = incident_detail %>% html_elements("#FollowerID option[selected]") %>% 
                 html_text2()%>% paste(collapse="; "),
               group_followers = incident_detail %>% html_elements("#FollowerGroupID option[selected]") %>% 
                 html_text2() %>% paste(collapse="; "),
               categories = incident_detail %>% html_elements("#CategoryID option[selected]") %>%
                 html_text2()%>% paste(collapse="; "),
               previous_incident_id = incident_detail %>% html_elements("#PreviousIncidentID option[selected]") %>% 
                 html_attr("value"),
               previous_incident = incident_detail %>% html_elements("#PreviousIncidentID option[selected]") %>% 
                 html_text2(),
               narrative = incident_detail %>% html_element("#Detail") %>% html_text2()%>% paste(collapse="; "),
               narrative_html = as.character(incident_detail %>% html_element("#Detail") %>% html_children()),
               actions = incident_detail %>% html_elements("#datatable_actions tbody tr"),
               visibility = incident_detail %>% html_element("#content .alert") %>% html_text(),
               appeals = incident_detail %>% html_element("#datatable_appeals") %>% html_table(),
               comments = incident_detail %>% html_element("#datatable_comments") %>% html_table(),
               files = incident_detail %>% html_elements("#datatable_files tbody tr")
)

incident_detail %>% html_element("#datatable_appeals")
files <- incident_detail %>% html_elements("#datatable_files tbody tr")

file_detail <- lst(file_uploaded_on = files[1] %>% html_element("td:nth-of-type(2)") %>% html_text2(),
                   file_url = files[1] %>% html_element("td:nth-of-type(3) a") %>% html_attr("href"),
                   file_name = files[1] %>% html_element("td:nth-of-type(3)") %>% html_text2(),
                   file_association = files[1] %>% html_element("td:nth-of-type(4)") %>% html_text2(),
                   file_visibility = files[1] %>% html_element("td:nth-of-type(5) span") %>% html_attr("data-original-title")
)

file_details <- get_file_details(files)
file_name_split <- file_details$file_url[1] %>% str_split("/")



file_content <- s %>% session_jump_to(file_details$file_url[1])

writeBin(file_content$response$content, URLdecode(paste(tail(file_name_split[[1]],2),collapse="_")))
?writeBin
```
```{r}
action_details <- tibble(action_date = actions %>% html_element("td:nth-of-type(2) span") %>% html_text2(),
                           action_created = actions %>% html_element("td:nth-of-type(2) span") %>% html_attr("title"),
                           action_author = actions %>% html_element("td:nth-of-type(2) a") %>% html_text2(),
                           action_text = actions %>% html_element("td:nth-of-type(3)") %>% html_text2(),
                           action_files = actions %>% html_element("td:nth-of-type(4)") %>% html_text2(),
                           action_read_acknowledged = actions %>% html_element("td:nth-of-type(8)") %>% html_text2(),
                           action_id = actions %>% html_element("td:nth-of-type(1) a") %>%
                             html_attr("onclick") %>%
                             str_extract("(?<=ActionID=)\\d+"),
                           action_url = actions %>% html_element("td:nth-of-type(1) a") %>% html_attr("onclick") %>%
                             str_extract("(?<=\\').*(?=\\')")
  )

action_details <- action_details %>% mutate(extra_details = map(action_url, get_extra_action_details))

action_details %>% unnest(extra_details)

get_extra_action_details(action_details$action_url)

# Actions
actions <- incident_detail %>% html_elements("#datatable_actions tbody tr")
actions[1]

actions[1] %>% html_elements("table")

url <- actions[1] %>% html_element("td:nth-of-type(1) a") %>% html_attr("onclick") %>% 
  str_extract("(?<=\\').*(?=\\')")



action_detail <- s %>% session_jump_to(url)
actions_details2 <- lst(action_title = action_detail %>% html_element("#actiontitle") %>% html_attr("value"),
                        action_type = action_detail %>% html_element("#ActionTypeID option[selected]") %>% html_text2(),
                        action_detail = action_detail %>% html_element("#ActionDetail") %>% html_text2(),
                        expectations = action_detail %>% html_element("#Expectations") %>% html_text2(),
                        consequences = action_detail %>% html_element("#Consequences") %>% html_text2(),
                        coaching %>% html_element("#CoachingOffered") %>% html_text2()
                        )

action_detail %>% html_element("#ActionTypeID option[selected]") %>% html_text2()
action_detail %>% html_element("#ActionDetail") %>% html_text2()

action_detail %>% html_elements("textarea")
```

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}
inc
```

